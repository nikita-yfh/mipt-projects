# Собственно взлом
## Анализ хеш-функии
Сама хеш-функция была обнаружена на адресе 0x01b6:
```
0000:01b6      xor     bx, bx
0000:01b8      lodsb   al, byte [si]
0000:01b9      xor     bl, al
0000:01bb      shr     bx, 1
0000:01bd      add     bh, al
0000:01bf      shl     bx, 3
0000:01c2      neg     bx
0000:01c4      shl     bx, 4
0000:01c7      loop    0xb8
0000:01c9      ret
```
При этом значение хеш-функии должно быть равно 0xb080:
```
0000:008d      cmp     bx, word [0x1a4] ; 0xb080

## Уязвимость 1
После ввода пароля ведется проверка:

```
0000:007b      cmp     byte [bx + 2], 0x24
0000:007f      je      0x99                    ; access
```

bx при этом указывает на начало буфера.

[bx] - размер буфера, [bx+1] - количество введенных символов.

Получается, bx+2 указывает на первый символ. И действительно, если ввести символ 0x24 ($), то разрешается доступ.
```
S:\DOC\PROJECTS>crackme.com
$
ACCESS ALLOWED!!!
S:\DOC\PROJECTS>
```

## Уязвимость 2
В начале основной функции выделяется память под 0x21 символа:
```
0000:006d      sub     sp, 0x23
```
Но при этом выставляется максимальный размер буфера 0xFD:
```
0000:0076      mov     byte [bx], 0xfe ; 254 ; read 254 chatacreters max
```
Соответственно можно перезаписать прошлые значения в стеке. Предыдущее значение в стеке - адрес возврата в функцию в начале программы (0x103).
Но если просто перезаписать его на адрес функцию разрешения доступа, то программа завершится некорректно.
Поэтому в самом буфере можно расположить код вызова функции и корректного завершения программы:
```
0000:ffda      jmp     0x1ae                ; e8 d1 01
0000:ffdd      mov     ah, 0x4c             ; b4 4c
0000:ffef      int     0x21                 ; cd 21
```
В десятичном виде это 232 209 1 180 76 205 33, можно ввести через ALT+XXX.
А адрес возврата перезаписать на 0xffda, в десятичном виде это 218 255.
В итоге:
```
S:\DOC\PROJECTS>crackme.com
1ш╤┤L═!901234567890123456789012345┌
ACCESS DENIED!!!
ACCESS ALLOWED!!!
S:\DOC\PROJECTS>
```

## KeyGen
Исправляет алгоритм хеш-функции, генерирует хеш по строке и заменяет его в программе. Таким образом, программа запустится только с нужным паролем.
